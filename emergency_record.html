<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>急診入院紀錄生成器</title>
    <link rel="icon" type="image/x-icon" href="icon_result (1).ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: transparent;
            min-height: 100vh;
            min-width: 850px;
            padding: 0;
            margin: 0;
            overflow-x: auto;
        }

        .container {
            min-width: 850px;
            width: 100%;
            height: 100vh;
            margin: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            border: none;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }



        .main-layout {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 15px;
            min-width: 810px;
            overflow: visible;
        }

        .left-panel, .right-panel {
            flex: 1;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding: 0 10px;
        }

        .form-section {
            background: rgba(248, 250, 252, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 3px solid rgba(99, 102, 241, 0.4);
            border: 1px solid rgba(226, 232, 240, 0.3);
        }
        
        .form-section.compact {
            margin-bottom: 5px !important;
        }

        .form-section h3 {
            color: #334155;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-row.vitals-first-row {
            gap: 8px !important;
        }

        .form-row.vitals-second-row {
            gap: 8px !important;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group.full-width {
            flex: 1;
            min-width: 100%;
        }

        .form-group.half-width {
            flex: 1;
            min-width: 250px;
        }

        .form-group.quarter-width {
            flex: 1;
            min-width: 150px;
        }

        .form-group.third-width {
            flex: 1;
            min-width: 180px;
        }

        .vital-group {
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .vitals-second-row .vital-group {
            flex: 0 0 auto;
            margin-right: 8px;
        }

        .vitals-second-row .vital-group:last-child {
            margin-right: 0;
        }

        .vitals-first-row .vital-group {
            flex: 0 0 auto;
            margin-right: 8px;
        }

        .vitals-first-row .vital-group:last-child {
            margin-right: 0;
        }

        .vital-group label {
            min-width: 35px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .vital-group label.oxygen-label {
            min-width: 60px;
        }

        .vital-group input {
            width: 50px;
            padding: 4px 6px;
            font-size: 0.85rem;
        }

        .vital-group input.pulse-input,
        .vital-group input.respiration-input {
            width: 40px;
        }

        .vital-group input.blood-pressure-input {
            width: 65px;
        }

        .vital-group select {
            width: 180px;
            padding: 4px 6px;
            font-size: 0.85rem;
        }

        .vital-group span {
            font-size: 0.75rem;
            color: #64748b;
            white-space: nowrap;
        }

        label {
            font-weight: 500;
            color: #475569;
            white-space: nowrap;
            min-width: 100px;
        }

        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid rgba(203, 213, 225, 0.5);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            color: #334155;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .full-width input, .full-width select, .full-width textarea {
            width: 100%;
        }

        .half-width input, .half-width select {
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }

        .btn-secondary {
            background: rgba(100, 116, 139, 0.8);
            color: white;
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.8);
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }



        .emergency-record {
            width: 100%;
            resize: vertical;
            font-family: inherit;
        }

        .emergency-record#emergency_record {
            min-height: 180px;
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .success-message {
            background: rgba(220, 252, 231, 0.8);
            color: #047857;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }





        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            


            
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-group.half-width,
            .form-group.quarter-width,
            .form-group.third-width {
                min-width: 100%;
            }

            .vital-group {
                min-width: 100%;
                margin-bottom: 10px;
            }

            .vital-group label {
                min-width: 60px;
            }

            .vital-group input {
                width: 60px;
            }

            .vital-group input.pulse-input,
            .vital-group input.respiration-input {
                width: 50px;
            }

            .vital-group input.blood-pressure-input {
                width: 75px;
            }

            .vital-group select {
                width: 180px;
            }

            .vital-group label.oxygen-label {
                min-width: 80px;
            }
            
            /* 病人意識EVM欄位響應式設計 */
            .consciousness-container {
                gap: 4px !important;
                max-width: 100% !important;
                overflow: hidden;
            }
            
            .consciousness-item {
                display: flex;
                align-items: center;
                gap: 2px;
                flex-shrink: 0;
            }
            
            .consciousness-item span {
                font-size: 0.85rem;
                min-width: 16px;
                white-space: nowrap;
            }
            
            .consciousness-item input {
                width: 35px !important;
                font-size: 0.85rem !important;
                padding: 2px 4px !important;
                border-radius: 3px;
            }
        }
        
        /* 更小屏幕的EVM欄位 */
        @media (max-width: 480px) {
            .consciousness-container {
                gap: 2px !important;
            }
            
            .consciousness-item {
                gap: 1px;
            }
            
            .consciousness-item span {
                font-size: 0.8rem;
                min-width: 14px;
            }
            
            .consciousness-item input {
                width: 30px !important;
                font-size: 0.8rem !important;
                padding: 1px 2px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-layout">
            <div class="left-panel">
                <div class="form-section">
                    <h3>病人基本資料</h3>
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>入院日期：</label>
                            <input type="date" id="admission_date">
                        </div>
                        <div class="form-group half-width">
                            <label>入院方式：</label>
                            <input type="text" id="admission_method" placeholder="外院轉入、119送醫？">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>病人意識：</label>
                            <div class="consciousness-container" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <div class="consciousness-item"><span>E：</span><input type="text" id="consciousness_e" maxlength="2" style="width: 45px;"></div>
                                <div class="consciousness-item"><span>V：</span><input type="text" id="consciousness_v" maxlength="2" style="width: 45px;"></div>
                                <div class="consciousness-item"><span>M：</span><input type="text" id="consciousness_m" maxlength="2" style="width: 45px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>入院原因：</label>
                            <input type="text" id="admission_reason" placeholder="就醫急診的原因，有什麼不適症狀、異常徵象，發生什麼事件？">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>主訴或代訴：</label>
                            <input type="text" id="chief_complaint" placeholder="請檢視【急診護理紀錄】中的病人主訴或他人代訴內容並整理。">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>生命徵象</h3>
                    <div class="form-row vitals-first-row" style="gap: 8px !important;">
                        <div class="vital-group">
                            <label>體溫：</label>
                            <input type="text" id="temperature" placeholder="36.5">
                            <span>°C</span>
                        </div>
                        <div class="vital-group">
                            <label>脈搏：</label>
                            <input type="text" id="pulse" placeholder="80" class="pulse-input">
                            <span>次/分</span>
                        </div>
                        <div class="vital-group">
                            <label>呼吸：</label>
                            <input type="text" id="respiration" placeholder="18" class="respiration-input">
                            <span>次/分</span>
                        </div>
                        <div class="vital-group">
                            <label>血壓：</label>
                            <input type="text" id="blood_pressure" placeholder="120/80" class="blood-pressure-input">
                            <span>mmHg</span>
                        </div>
                    </div>
                    <div class="form-row vitals-second-row" style="gap: 8px !important;">
                        <div class="vital-group">
                            <label>血糖：</label>
                            <input type="text" id="blood_sugar" placeholder="100">
                            <span>mg/dL</span>
                        </div>
                        <div class="vital-group">
                            <label>血氧：</label>
                            <input type="text" id="spo2" placeholder="98">
                            <span>%</span>
                        </div>
                        <div class="vital-group">
                            <label class="oxygen-label">氧氣使用：</label>
                            <select id="oxygen_device">
                                <option value="">請選擇</option>
                                <option value="Nasal Cannula">Nasal Cannula</option>
                                <option value="Simple Mask">Simple Mask</option>
                                <option value="Venturi Mask">Venturi Mask</option>
                                <option value="Non-Rebreathing Mask">Non-Rebreathing Mask</option>
                                <option value="HFNC">HFNC</option>
                                <option value="BiPAP">BiPAP</option>
                                <option value="採室氧濃度">採室氧濃度</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>急診護理紀錄彙整重點</h3>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>發生事件：</label>
                            <textarea id="present_history" rows="3" placeholder="例如：簽立DNR、疾病變化的醫囑處置、用藥及檢查原因、放置管路原因，特殊紀錄事件等等。"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>初步診斷：</label>
                            <textarea id="diagnosis" rows="3" placeholder="於急診疑似什麼疾病診斷？如：吸入性肺炎、感染、癌症、氣胸、骨折等等。"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>過去病史：</label>
                            <textarea id="past_history" rows="3" placeholder="請輸入過去病史，慢性疾病、癌症、近期手術？"></textarea>
                        </div>
                    </div>
                </div>

            </div>

            <div class="right-panel">
                <div class="form-section">
                    <h3>急診醫囑【檢查處置】</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.9rem;">
                        進入HIS急診醫囑【檢查處置】複製項目名稱第一個欄位即可，點擊下方按鈕開始。
                    </p>
                    
                    <button type="button" class="btn btn-primary" onclick="openTextConverter()" style="width: 100%; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                        貼上醫囑
                    </button>
                    


                    <div class="form-section compact" style="flex: 1; margin-top: 15px; padding-bottom: 10px;">
                        <h4 style="color: #334155; margin-bottom: 10px; font-size: 1rem;">生成結果</h4>
                        <textarea id="converted_text" class="emergency-record" placeholder="生成後的醫囑將顯示在此。" style="height: 130px; font-family: 'Courier New', monospace; font-size: 17px; line-height: 1.3; resize: none;"></textarea>
                        
                        <!-- 按鈕區域 -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-success" onclick="copyConvertedText()">📋 複製</button>
                            <button type="button" class="btn btn-secondary" onclick="clearConvertedText()">🗑️ 清除</button>
                        </div>
                        
                        <div id="convert_success_message" class="success-message" style="margin-top: 5px; margin-bottom: 0;">✅ 操作完成並已複製到剪貼簿！</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>急診入院紀錄</h3>
                    <textarea id="emergency_record" class="emergency-record" placeholder="急診入院紀錄將自動生成在此。"></textarea>
                    <div id="success_message" class="success-message">✅ 急診入院紀錄已生成完成！</div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="generateEmergencyRecord()">✨ 生成紀錄</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAllFields()">🗑️ 清除</button>
                    <button type="button" class="btn btn-success" onclick="copyRecord()">📋 複製</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數：術語對照表
        let medicalTermsMapping = {};
        let customMappings = {};
        let isMappingsLoaded = false;

        // 從外部 JSON 檔案載入術語對照表
        async function loadMedicalTermsMapping() {
            try {
                const response = await fetch('./medical_terms_mapping.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                medicalTermsMapping = data.mappings || {};
                isMappingsLoaded = true;
                console.log(`✅ 已從外部檔案載入 ${Object.keys(medicalTermsMapping).length} 條術語對照`);
                
                // 載入自定義對照表
                loadCustomMappingsFromStorage();
            } catch (error) {
                console.warn('⚠️ 無法載入外部術語對照表，使用預設值：', error);
                // 使用預設的術語對照表
                medicalTermsMapping = {
                    'Blood gas analysis_靜脈血氣體分析(送檢驗科執行)': 'VBG',
                    'Blood gas analysis_動脈血氣體分析(送檢驗科執行)': 'ABG',
                    'Lactic Acid (lactate)': 'Lactate',
                    'Procalcitonin(PCT)': 'PCT',
                    'Sputum Culture + Sputum Routine aerobic culture': 'Sputum C+R',
                    '抗酸性濃縮抹片染色+抗酸菌培養(未用藥)': 'AFB',
                    'Pleural effusion culture (Aer & Anaerobic)': 'Pleural/C',
                    'MTB PCR/RIF(抗藥基因)': 'TB(_)',
                    'Blood culture (Aer,Anaerobic,Fungus)': 'B/C*1套',
                    'Blood culture (for resin , Aer & Anaerobic)大人使用': 'ARD*1套',
                    '抗原快篩 - 新型冠狀病毒抗原檢測SARS-CoV-2 Ag test': 'COVID-19(_)',
                    'Inf A 流感核酸快篩': 'A型流感(_)',
                    'Inf B 流感核酸快篩': 'B型流感(_)',
                    'Mycoplasma pneumonia IgM (快速法)': 'Mycoplasma(_)',
                    '肺炎披衣菌抗體IgM (快速法)': '肺炎披衣菌抗體(_)',
                    '退伍役軍人症尿液抗原快速檢測': '退伍役軍人症(_)',
                    'Pneumococcus Ag (urine) 尿液肺炎球菌抗原': '肺炎球菌抗原(_)',
                    'K.U.B._AP': 'KUB',
                    'Chest PA': 'CXR',
                    'Chest AP': 'CXR',
                    'E.K.G.(左)(限病房執行)': 'EKG',
                    '超音波心臟圖 (心內)': '心臟超音波',
                    '杜卜勒氏彩色心臟血流圖 (心內)': '心臟超音波',
                    'Abdominal sonography腹部超音波(胃腸科)': '腹部超音波',
                    'CT without / with contrast_Chest': 'Chest_CT',
                    'CT without / with contrast_Abdomen': 'Abdomen_CT',
                    'CT without contrast_Brain': 'Brain_CT',
                    'MRI (with) contrast_Brain': 'Brain_MIR',
                    'Urine routine examination': 'U/A',
                    'Urine aerobic culture': 'U/C',
                    'Salmonella,Shigella or other Pathogens culture': 'Salmonella(_)',
                    'Stool Occult Blood(EIA/LIA) 糞便潛血免疫分析': 'Stool EIA(_/_)',
                    '(on Foley)留置導尿 Urinal indwelling catheterlization(病房專用)': 'On Foley',
                    '(ON NG TUBE)胃管插入Insertion of nasogastric tube': 'On NG',
                    '(ICP)一般導尿 URINAL CATHETERLIZATION(病房專用)': '單次導尿',
                    '(ON CVP)中央靜脈導管置入術 C.V.P. CATHETER INTUBATION': 'On CVP',
                    '小量或留置灌腸': '灌腸',
                    '胸腔穿刺 Thoracocentesis': '胸腔穿刺引流'
                };
                isMappingsLoaded = true;
                loadCustomMappingsFromStorage();
            }
        }

        // 讀取系統設置中的自定義術語對照表
        function loadCustomMappingsFromStorage() {
            try {
                const savedData = localStorage.getItem('medicalTermsMappings');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    customMappings = data.customMappings || {};
                    console.log(`📂 已載入 ${Object.keys(customMappings).length} 條自定義對照規則`);
                }
            } catch (error) {
                console.warn('⚠️ 無法載入自定義對照表：', error);
                customMappings = {};
            }
        }

        function openTextConverter() {
            let processedMedicalData = null; // 暫存處理後的醫囑資料
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50; text-align: center;">急診醫囑檢查處置</h3>
                <p style="margin-bottom: 15px; color: #6c757d;">請貼上急診中的醫囑檢查處置，關閉視窗後將自動套用。</p>
                <textarea id="medical_input" style="width: 100%; height: 300px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Microsoft JhengHei', sans-serif; font-size: 14px; line-height: 1.5;" placeholder="請貼上醫療檢查項目，每行一個項目..."></textarea>
                <div style="margin-top: 20px;">
                    <div id="convert_status_message" style="padding: 10px; border-radius: 6px; display: none;"></div>
                    <button id="close_btn" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer; min-width: 80px; float: right; margin-top: 10px;">關閉</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const textArea = document.getElementById('medical_input');
            const statusDiv = document.getElementById('convert_status_message');
            textArea.focus();
            
            // 關閉視窗並套用資料的函數
            function closeModalAndApplyData() {
                // 將暫存的資料套用到文字欄位
                if (processedMedicalData) {
                    document.getElementById('converted_text').value = processedMedicalData;
                    console.log('✅ 醫囑資料已套用到文字欄位');
                }
                
                // 關閉視窗
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }
            
            // 自動轉換功能 - 貼上後解析但不立即輸出
            textArea.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const inputData = textArea.value.trim();
                    if (inputData) {
                        try {
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#fff3cd';
                            statusDiv.style.color = '#856404';
                            statusDiv.style.border = '1px solid #ffeaa7';
                            statusDiv.textContent = '⚡ 正在解析醫囑資料...';
                            
                            // 解析資料但不直接輸出到主文字欄位
                            processedMedicalData = convertMedicalTerms(inputData);
                            
                            statusDiv.style.background = '#d4edda';
                            statusDiv.style.color = '#155724';
                            statusDiv.style.border = '1px solid #c3e6cb';
                            statusDiv.textContent = '✅ 完成！將會自動關閉視窗。';
                            
                            console.log('✅ 醫囑解析完成！');
                            
                            // 2秒後自動關閉並套用資料
                            setTimeout(() => {
                                if (document.body.contains(modal)) {
                                    console.log('🚪 自動關閉視窗並套用醫囑資料');
                                    closeModalAndApplyData();
                                }
                            }, 2000);
                            
                        } catch (error) {
                            console.error('❌ 醫囑解析失敗：', error);
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#f8d7da';
                            statusDiv.style.color = '#721c24';
                            statusDiv.style.border = '1px solid #f5c6cb';
                            statusDiv.textContent = '❌ 解析失敗：' + error.message;
                        }
                    } else {
                        statusDiv.style.display = 'none';
                        console.log('⚠️ 貼上的資料為空');
                    }
                }, 100); // 100毫秒延遲確保貼上內容完全載入
            });
            
            // 關閉按鈕事件
            document.getElementById('close_btn').onclick = () => {
                closeModalAndApplyData();
            };
            
            // 點擊背景關閉並套用資料
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModalAndApplyData();
                }
            };
            
            // ESC鍵關閉並套用資料
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    if (document.body.contains(modal)) {
                        closeModalAndApplyData();
                    }
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }

        function convertMedicalTerms(inputText) {
            // 讀取系統設置中的自定義術語對照表
            const customMappings = loadCustomMappingsFromStorage();
            
            // 合併預設和自定義對照表
            const allMappings = { ...medicalTermsMapping, ...customMappings };
            
            const lines = inputText.split('\n');
            const convertedLines = [];
            let totalLines = 0;
            let convertedCount = 0;
            let defaultCount = 0;
            let hasBloodTest = false; // 追蹤是否已有追蹤抽血
            
            console.log(`📊 使用對照表：預設 ${Object.keys(medicalTermsMapping).length} 條 + 自定義 ${Object.keys(customMappings).length} 條`);
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    totalLines++;
                    let converted = false;
                    
                    // 檢查是否有自定義的 = 標記
                    if (trimmedLine.includes('=')) {
                        const parts = trimmedLine.split('=');
                        if (parts.length === 2) {
                            const result = parts[1].trim();
                            convertedLines.push(result);
                            convertedCount++;
                            converted = true;
                            console.log(`🔧 自定義標記：${parts[0].trim()} → ${result}`);
                        }
                    }
                    
                    if (!converted) {
                        // 精確匹配合併後的對照表
                        if (allMappings[trimmedLine]) {
                            convertedLines.push(allMappings[trimmedLine]);
                            convertedCount++;
                            converted = true;
                            const isCustom = customMappings[trimmedLine] ? '（自定義）' : '';
                            console.log(`✅ 精確匹配${isCustom}：${trimmedLine} → ${allMappings[trimmedLine]}`);
                        } else {
                            // 模糊匹配合併後的對照表
                            for (const [key, value] of Object.entries(allMappings)) {
                                if (key.includes(trimmedLine) || trimmedLine.includes(key)) {
                                    convertedLines.push(value);
                                    convertedCount++;
                                    converted = true;
                                    const isCustom = customMappings[key] ? '（自定義）' : '';
                                    console.log(`🔍 模糊匹配${isCustom}：${trimmedLine} → ${value}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // 如果都沒有匹配到，預設為"追蹤抽血"（但只加入一次）
                    if (!converted) {
                        if (!hasBloodTest) {
                            convertedLines.push('予追蹤抽血');
                            hasBloodTest = true;
                            console.log(`📋 預設處理（首次）：${trimmedLine} → 予追蹤抽血`);
                        } else {
                            console.log(`📋 預設處理（已存在）：${trimmedLine} → 予追蹤抽血（不重複加入）`);
                        }
                        defaultCount++;
                    }
                }
            });
            
            // 合併相同的血液培養項目並計算套數
            const mergedResults = mergeBloodCultures(convertedLines);
            
            return mergedResults.join('、');
        }

        function mergeBloodCultures(convertedLines) {
            const itemCount = {};
            const mergedResults = [];
            
            // 計算每個項目的出現次數
            convertedLines.forEach(item => {
                if (item === 'B/C*1套') {
                    itemCount['B/C'] = (itemCount['B/C'] || 0) + 1;
                } else if (item === 'ARD*1套') {
                    itemCount['ARD'] = (itemCount['ARD'] || 0) + 1;
                } else {
                    // 非血液培養項目，直接加入結果
                    mergedResults.push(item);
                }
            });
            
            // 將血液培養項目加入結果，並標示正確的套數
            for (const [key, count] of Object.entries(itemCount)) {
                mergedResults.push(`${key}*${count}套`);
            }
            
            return mergedResults;
        }

        function copyConvertedText() {
            const convertedText = document.getElementById('converted_text').value;
            if (!convertedText.trim()) {
                console.log('⚠️ 沒有可複製的轉換結果');
                return;
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(convertedText).then(() => {
                    console.log('✅ 轉換結果已複製到剪貼簿');
                    
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ 已複製';
                    btn.style.background = '#28a745';
                    
                    const successMsg = document.getElementById('convert_success_message');
                    successMsg.style.display = 'block';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        successMsg.style.display = 'none';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('複製失敗：', err);
                    fallbackCopyConverted(convertedText);
                });
            } else {
                fallbackCopyConverted(convertedText);
            }
        }

        function fallbackCopyConverted(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('✅ 轉換結果已複製到剪貼簿（備用方法）');
                
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ 已複製';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                
            } catch (err) {
                console.log('❌ 複製失敗，請手動選取文字複製');
            }
            document.body.removeChild(textArea);
        }

        function clearConvertedText() {
            document.getElementById('converted_text').value = '';
            console.log('✅ 轉換結果已清除');
        }

        function generateEmergencyRecord() {
            const data = {
                patient: {
                    admission_date: document.getElementById('admission_date').value,
                    admission_method: document.getElementById('admission_method').value,
                    admission_reason: document.getElementById('admission_reason').value,
                    chief_complaint: document.getElementById('chief_complaint').value
                },
                vitals: {
                    temperature: document.getElementById('temperature').value,
                    pulse: document.getElementById('pulse').value,
                    respiration: document.getElementById('respiration').value,
                    blood_pressure: document.getElementById('blood_pressure').value,
                    spo2: document.getElementById('spo2').value,
                    blood_sugar: document.getElementById('blood_sugar').value,
                    oxygen_device: document.getElementById('oxygen_device').value
                },
                consciousness: {
                    e: document.getElementById('consciousness_e').value,
                    v: document.getElementById('consciousness_v').value,
                    m: document.getElementById('consciousness_m').value
                },
                diagnosis: document.getElementById('diagnosis').value,
                past_history: document.getElementById('past_history').value,
                present_history: document.getElementById('present_history').value
            };

            const recordParts = [];

            // 入院日期
            if (data.patient.admission_date) {
                recordParts.push(data.patient.admission_date);
            }

            // 入院方式
            if (data.patient.admission_method) {
                recordParts.push(data.patient.admission_method);
            }

            // 病人意識
            if (data.consciousness.e || data.consciousness.v || data.consciousness.m) {
                recordParts.push(`E${data.consciousness.e}V${data.consciousness.v}M${data.consciousness.m}`);
            }

            // 入院原因
            if (data.patient.admission_reason) {
                recordParts.push(data.patient.admission_reason);
            }

            // 主訴或代訴
            if (data.patient.chief_complaint) {
                recordParts.push(data.patient.chief_complaint);
            }

            // 生命徵象
            const vitals = [];
            if (data.vitals.temperature) vitals.push(`體溫${data.vitals.temperature}°C`);
            if (data.vitals.pulse) vitals.push(`脈搏${data.vitals.pulse}次/分`);
            if (data.vitals.respiration) vitals.push(`呼吸${data.vitals.respiration}次/分`);
            if (data.vitals.blood_pressure) vitals.push(`血壓${data.vitals.blood_pressure}mmHg`);
            if (data.vitals.spo2) vitals.push(`血氧${data.vitals.spo2}%`);
            if (data.vitals.blood_sugar) vitals.push(`血糖${data.vitals.blood_sugar}mg/dL`);
            
            if (vitals.length > 0) {
                recordParts.push(vitals.join('、'));
            }

            // 氧氣裝置
            if (data.vitals.oxygen_device) {
                if (data.vitals.oxygen_device === '採室氧濃度') {
                    recordParts.push(data.vitals.oxygen_device);
                } else {
                    recordParts.push(`${data.vitals.oxygen_device}氧氣使用`);
                }
            }

            // 發生事件（原現在病史）
            if (data.present_history) {
                recordParts.push(data.present_history);
            }

            // 初步診斷
            if (data.diagnosis) {
                recordParts.push(data.diagnosis);
            }

            // 過去病史
            if (data.past_history) {
                recordParts.push(data.past_history);
            }

            // 轉換後的醫囑資料
            const convertedData = document.getElementById('converted_text').value;
            if (convertedData && convertedData.trim() !== '') {
                recordParts.push(convertedData);
            }

            // 固定結尾
            if (recordParts.length > 0) {
                recordParts.push('經醫師評估後建議入院治療');
            }

            // 組合完整紀錄
            let finalRecord = '';
            if (recordParts.length > 0) {
                finalRecord = recordParts.join('，') + '。';
            }

            document.getElementById('emergency_record').value = finalRecord;

            // 顯示成功訊息
            const successMsg = document.getElementById('success_message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        function clearAllFields() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.value = '';
            });
            console.log('✅ 所有欄位已清除');
        }



        function copyRecord() {
            const recordText = document.getElementById('emergency_record').value;
            if (!recordText.trim()) {
                console.log('⚠️ 沒有可複製的內容');
                return;
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(recordText).then(() => {
                    console.log('✅ 急診入院紀錄已複製到剪貼簿');
                    
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ 已複製';
                    btn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1500);
                }).catch(err => {
                    console.error('複製失敗：', err);
                });
            }
        }

        // 頁面載入時自動載入術語對照表
        document.addEventListener('DOMContentLoaded', function() {
            loadMedicalTermsMapping();
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€¥è¨ºå…¥é™¢ç´€éŒ„ç”Ÿæˆå™¨</title>
    <link rel="icon" type="image/x-icon" href="icon_result (1).ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: transparent;
            min-height: 100vh;
            min-width: 850px;
            padding: 0;
            margin: 0;
            overflow-x: auto;
        }

        .container {
            min-width: 850px;
            width: 100%;
            height: 100vh;
            margin: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            border: none;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }



        .main-layout {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 15px;
            min-width: 810px;
            overflow: visible;
        }

        .left-panel, .right-panel {
            flex: 1;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding: 0 10px;
        }

        .form-section {
            background: rgba(248, 250, 252, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 3px solid rgba(99, 102, 241, 0.4);
            border: 1px solid rgba(226, 232, 240, 0.3);
        }
        
        .form-section.compact {
            margin-bottom: 5px !important;
        }

        .form-section h3 {
            color: #334155;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-row.vitals-first-row {
            gap: 8px !important;
        }

        .form-row.vitals-second-row {
            gap: 8px !important;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group.full-width {
            flex: 1;
            min-width: 100%;
        }

        .form-group.half-width {
            flex: 1;
            min-width: 250px;
        }

        .form-group.quarter-width {
            flex: 1;
            min-width: 150px;
        }

        .form-group.third-width {
            flex: 1;
            min-width: 180px;
        }

        .vital-group {
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .vitals-second-row .vital-group {
            flex: 0 0 auto;
            margin-right: 8px;
        }

        .vitals-second-row .vital-group:last-child {
            margin-right: 0;
        }

        .vitals-first-row .vital-group {
            flex: 0 0 auto;
            margin-right: 8px;
        }

        .vitals-first-row .vital-group:last-child {
            margin-right: 0;
        }

        .vital-group label {
            min-width: 35px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .vital-group label.oxygen-label {
            min-width: 60px;
        }

        .vital-group input {
            width: 50px;
            padding: 4px 6px;
            font-size: 0.85rem;
        }

        .vital-group input.pulse-input,
        .vital-group input.respiration-input {
            width: 40px;
        }

        .vital-group input.blood-pressure-input {
            width: 65px;
        }

        .vital-group select {
            width: 180px;
            padding: 4px 6px;
            font-size: 0.85rem;
        }

        .vital-group span {
            font-size: 0.75rem;
            color: #64748b;
            white-space: nowrap;
        }

        label {
            font-weight: 500;
            color: #475569;
            white-space: nowrap;
            min-width: 100px;
        }

        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid rgba(203, 213, 225, 0.5);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            color: #334155;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .full-width input, .full-width select, .full-width textarea {
            width: 100%;
        }

        .half-width input, .half-width select {
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }

        .btn-secondary {
            background: rgba(100, 116, 139, 0.8);
            color: white;
        }

        .btn-success {
            background: rgba(34, 197, 94, 0.8);
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }



        .emergency-record {
            width: 100%;
            resize: vertical;
            font-family: inherit;
        }

        .emergency-record#emergency_record {
            min-height: 180px;
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .success-message {
            background: rgba(220, 252, 231, 0.8);
            color: #047857;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }





        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            


            
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-group.half-width,
            .form-group.quarter-width,
            .form-group.third-width {
                min-width: 100%;
            }

            .vital-group {
                min-width: 100%;
                margin-bottom: 10px;
            }

            .vital-group label {
                min-width: 60px;
            }

            .vital-group input {
                width: 60px;
            }

            .vital-group input.pulse-input,
            .vital-group input.respiration-input {
                width: 50px;
            }

            .vital-group input.blood-pressure-input {
                width: 75px;
            }

            .vital-group select {
                width: 180px;
            }

            .vital-group label.oxygen-label {
                min-width: 80px;
            }
            
            /* ç—…äººæ„è­˜EVMæ¬„ä½éŸ¿æ‡‰å¼è¨­è¨ˆ */
            .consciousness-container {
                gap: 4px !important;
                max-width: 100% !important;
                overflow: hidden;
            }
            
            .consciousness-item {
                display: flex;
                align-items: center;
                gap: 2px;
                flex-shrink: 0;
            }
            
            .consciousness-item span {
                font-size: 0.85rem;
                min-width: 16px;
                white-space: nowrap;
            }
            
            .consciousness-item input {
                width: 35px !important;
                font-size: 0.85rem !important;
                padding: 2px 4px !important;
                border-radius: 3px;
            }
        }
        
        /* æ›´å°å±å¹•çš„EVMæ¬„ä½ */
        @media (max-width: 480px) {
            .consciousness-container {
                gap: 2px !important;
            }
            
            .consciousness-item {
                gap: 1px;
            }
            
            .consciousness-item span {
                font-size: 0.8rem;
                min-width: 14px;
            }
            
            .consciousness-item input {
                width: 30px !important;
                font-size: 0.8rem !important;
                padding: 1px 2px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-layout">
            <div class="left-panel">
                <div class="form-section">
                    <h3>ç—…äººåŸºæœ¬è³‡æ–™</h3>
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>å…¥é™¢æ—¥æœŸï¼š</label>
                            <input type="date" id="admission_date">
                        </div>
                        <div class="form-group half-width">
                            <label>å…¥é™¢æ–¹å¼ï¼š</label>
                            <input type="text" id="admission_method" placeholder="å¤–é™¢è½‰å…¥ã€119é€é†«ï¼Ÿ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç—…äººæ„è­˜ï¼š</label>
                            <div class="consciousness-container" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <div class="consciousness-item"><span>Eï¼š</span><input type="text" id="consciousness_e" maxlength="2" style="width: 45px;"></div>
                                <div class="consciousness-item"><span>Vï¼š</span><input type="text" id="consciousness_v" maxlength="2" style="width: 45px;"></div>
                                <div class="consciousness-item"><span>Mï¼š</span><input type="text" id="consciousness_m" maxlength="2" style="width: 45px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>å…¥é™¢åŸå› ï¼š</label>
                            <input type="text" id="admission_reason" placeholder="å°±é†«æ€¥è¨ºçš„åŸå› ï¼Œæœ‰ä»€éº¼ä¸é©ç—‡ç‹€ã€ç•°å¸¸å¾µè±¡ï¼Œç™¼ç”Ÿä»€éº¼äº‹ä»¶ï¼Ÿ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>ä¸»è¨´æˆ–ä»£è¨´ï¼š</label>
                            <input type="text" id="chief_complaint" placeholder="è«‹æª¢è¦–ã€æ€¥è¨ºè­·ç†ç´€éŒ„ã€‘ä¸­çš„ç—…äººä¸»è¨´æˆ–ä»–äººä»£è¨´å…§å®¹ä¸¦æ•´ç†ã€‚">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ç”Ÿå‘½å¾µè±¡</h3>
                    <div class="form-row vitals-first-row" style="gap: 8px !important;">
                        <div class="vital-group">
                            <label>é«”æº«ï¼š</label>
                            <input type="text" id="temperature" placeholder="36.5">
                            <span>Â°C</span>
                        </div>
                        <div class="vital-group">
                            <label>è„ˆæï¼š</label>
                            <input type="text" id="pulse" placeholder="80" class="pulse-input">
                            <span>æ¬¡/åˆ†</span>
                        </div>
                        <div class="vital-group">
                            <label>å‘¼å¸ï¼š</label>
                            <input type="text" id="respiration" placeholder="18" class="respiration-input">
                            <span>æ¬¡/åˆ†</span>
                        </div>
                        <div class="vital-group">
                            <label>è¡€å£“ï¼š</label>
                            <input type="text" id="blood_pressure" placeholder="120/80" class="blood-pressure-input">
                            <span>mmHg</span>
                        </div>
                    </div>
                    <div class="form-row vitals-second-row" style="gap: 8px !important;">
                        <div class="vital-group">
                            <label>è¡€ç³–ï¼š</label>
                            <input type="text" id="blood_sugar" placeholder="100">
                            <span>mg/dL</span>
                        </div>
                        <div class="vital-group">
                            <label>è¡€æ°§ï¼š</label>
                            <input type="text" id="spo2" placeholder="98">
                            <span>%</span>
                        </div>
                        <div class="vital-group">
                            <label class="oxygen-label">æ°§æ°£ä½¿ç”¨ï¼š</label>
                            <select id="oxygen_device">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Nasal Cannula">Nasal Cannula</option>
                                <option value="Simple Mask">Simple Mask</option>
                                <option value="Venturi Mask">Venturi Mask</option>
                                <option value="Non-Rebreathing Mask">Non-Rebreathing Mask</option>
                                <option value="HFNC">HFNC</option>
                                <option value="BiPAP">BiPAP</option>
                                <option value="æ¡å®¤æ°§æ¿ƒåº¦">æ¡å®¤æ°§æ¿ƒåº¦</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>æ€¥è¨ºè­·ç†ç´€éŒ„å½™æ•´é‡é»</h3>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>ç™¼ç”Ÿäº‹ä»¶ï¼š</label>
                            <textarea id="present_history" rows="3" placeholder="ä¾‹å¦‚ï¼šç°½ç«‹DNRã€ç–¾ç—…è®ŠåŒ–çš„é†«å›‘è™•ç½®ã€ç”¨è—¥åŠæª¢æŸ¥åŸå› ã€æ”¾ç½®ç®¡è·¯åŸå› ï¼Œç‰¹æ®Šç´€éŒ„äº‹ä»¶ç­‰ç­‰ã€‚"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>åˆæ­¥è¨ºæ–·ï¼š</label>
                            <textarea id="diagnosis" rows="3" placeholder="æ–¼æ€¥è¨ºç–‘ä¼¼ä»€éº¼ç–¾ç—…è¨ºæ–·ï¼Ÿå¦‚ï¼šå¸å…¥æ€§è‚ºç‚ã€æ„ŸæŸ“ã€ç™Œç—‡ã€æ°£èƒ¸ã€éª¨æŠ˜ç­‰ç­‰ã€‚"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>éå»ç—…å²ï¼š</label>
                            <textarea id="past_history" rows="3" placeholder="è«‹è¼¸å…¥éå»ç—…å²ï¼Œæ…¢æ€§ç–¾ç—…ã€ç™Œç—‡ã€è¿‘æœŸæ‰‹è¡“ï¼Ÿ"></textarea>
                        </div>
                    </div>
                </div>

            </div>

            <div class="right-panel">
                <div class="form-section">
                    <h3>æ€¥è¨ºé†«å›‘ã€æª¢æŸ¥è™•ç½®ã€‘</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.9rem;">
                        é€²å…¥HISæ€¥è¨ºé†«å›‘ã€æª¢æŸ¥è™•ç½®ã€‘è¤‡è£½é …ç›®åç¨±ç¬¬ä¸€å€‹æ¬„ä½å³å¯ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ã€‚
                    </p>
                    
                    <button type="button" class="btn btn-primary" onclick="openTextConverter()" style="width: 100%; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                        è²¼ä¸Šé†«å›‘
                    </button>
                    


                    <div class="form-section compact" style="flex: 1; margin-top: 15px; padding-bottom: 10px;">
                        <h4 style="color: #334155; margin-bottom: 10px; font-size: 1rem;">ç”Ÿæˆçµæœ</h4>
                        <textarea id="converted_text" class="emergency-record" placeholder="ç”Ÿæˆå¾Œçš„é†«å›‘å°‡é¡¯ç¤ºåœ¨æ­¤ã€‚" style="height: 130px; font-family: 'Courier New', monospace; font-size: 17px; line-height: 1.3; resize: none;"></textarea>
                        
                        <!-- æŒ‰éˆ•å€åŸŸ -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-success" onclick="copyConvertedText()">ğŸ“‹ è¤‡è£½</button>
                            <button type="button" class="btn btn-secondary" onclick="clearConvertedText()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                        
                        <div id="convert_success_message" class="success-message" style="margin-top: 5px; margin-bottom: 0;">âœ… æ“ä½œå®Œæˆä¸¦å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>æ€¥è¨ºå…¥é™¢ç´€éŒ„</h3>
                    <textarea id="emergency_record" class="emergency-record" placeholder="æ€¥è¨ºå…¥é™¢ç´€éŒ„å°‡è‡ªå‹•ç”Ÿæˆåœ¨æ­¤ã€‚"></textarea>
                    <div id="success_message" class="success-message">âœ… æ€¥è¨ºå…¥é™¢ç´€éŒ„å·²ç”Ÿæˆå®Œæˆï¼</div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="generateEmergencyRecord()">âœ¨ ç”Ÿæˆç´€éŒ„</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAllFields()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button type="button" class="btn btn-success" onclick="copyRecord()">ğŸ“‹ è¤‡è£½</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸ï¼šè¡“èªå°ç…§è¡¨
        let medicalTermsMapping = {};
        let customMappings = {};
        let isMappingsLoaded = false;

        // å¾å¤–éƒ¨ JSON æª”æ¡ˆè¼‰å…¥è¡“èªå°ç…§è¡¨
        async function loadMedicalTermsMapping() {
            try {
                const response = await fetch('./medical_terms_mapping.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                medicalTermsMapping = data.mappings || {};
                isMappingsLoaded = true;
                console.log(`âœ… å·²å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥ ${Object.keys(medicalTermsMapping).length} æ¢è¡“èªå°ç…§`);
                
                // è¼‰å…¥è‡ªå®šç¾©å°ç…§è¡¨
                loadCustomMappingsFromStorage();
            } catch (error) {
                console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥å¤–éƒ¨è¡“èªå°ç…§è¡¨ï¼Œä½¿ç”¨é è¨­å€¼ï¼š', error);
                // ä½¿ç”¨é è¨­çš„è¡“èªå°ç…§è¡¨
                medicalTermsMapping = {
                    'Blood gas analysis_éœè„ˆè¡€æ°£é«”åˆ†æ(é€æª¢é©—ç§‘åŸ·è¡Œ)': 'VBG',
                    'Blood gas analysis_å‹•è„ˆè¡€æ°£é«”åˆ†æ(é€æª¢é©—ç§‘åŸ·è¡Œ)': 'ABG',
                    'Lactic Acid (lactate)': 'Lactate',
                    'Procalcitonin(PCT)': 'PCT',
                    'Sputum Culture + Sputum Routine aerobic culture': 'Sputum C+R',
                    'æŠ—é…¸æ€§æ¿ƒç¸®æŠ¹ç‰‡æŸ“è‰²+æŠ—é…¸èŒåŸ¹é¤Š(æœªç”¨è—¥)': 'AFB',
                    'Pleural effusion culture (Aer & Anaerobic)': 'Pleural/C',
                    'MTB PCR/RIF(æŠ—è—¥åŸºå› )': 'TB(_)',
                    'Blood culture (Aer,Anaerobic,Fungus)': 'B/C*1å¥—',
                    'Blood culture (for resin , Aer & Anaerobic)å¤§äººä½¿ç”¨': 'ARD*1å¥—',
                    'æŠ—åŸå¿«ç¯© - æ–°å‹å† ç‹€ç—…æ¯’æŠ—åŸæª¢æ¸¬SARS-CoV-2 Ag test': 'COVID-19(_)',
                    'Inf A æµæ„Ÿæ ¸é…¸å¿«ç¯©': 'Aå‹æµæ„Ÿ(_)',
                    'Inf B æµæ„Ÿæ ¸é…¸å¿«ç¯©': 'Bå‹æµæ„Ÿ(_)',
                    'Mycoplasma pneumonia IgM (å¿«é€Ÿæ³•)': 'Mycoplasma(_)',
                    'è‚ºç‚æŠ«è¡£èŒæŠ—é«”IgM (å¿«é€Ÿæ³•)': 'è‚ºç‚æŠ«è¡£èŒæŠ—é«”(_)',
                    'é€€ä¼å½¹è»äººç—‡å°¿æ¶²æŠ—åŸå¿«é€Ÿæª¢æ¸¬': 'é€€ä¼å½¹è»äººç—‡(_)',
                    'Pneumococcus Ag (urine) å°¿æ¶²è‚ºç‚çƒèŒæŠ—åŸ': 'è‚ºç‚çƒèŒæŠ—åŸ(_)',
                    'K.U.B._AP': 'KUB',
                    'Chest PA': 'CXR',
                    'Chest AP': 'CXR',
                    'E.K.G.(å·¦)(é™ç—…æˆ¿åŸ·è¡Œ)': 'EKG',
                    'è¶…éŸ³æ³¢å¿ƒè‡Ÿåœ– (å¿ƒå…§)': 'å¿ƒè‡Ÿè¶…éŸ³æ³¢',
                    'æœåœå‹’æ°å½©è‰²å¿ƒè‡Ÿè¡€æµåœ– (å¿ƒå…§)': 'å¿ƒè‡Ÿè¶…éŸ³æ³¢',
                    'Abdominal sonographyè…¹éƒ¨è¶…éŸ³æ³¢(èƒƒè…¸ç§‘)': 'è…¹éƒ¨è¶…éŸ³æ³¢',
                    'CT without / with contrast_Chest': 'Chest_CT',
                    'CT without / with contrast_Abdomen': 'Abdomen_CT',
                    'CT without contrast_Brain': 'Brain_CT',
                    'MRI (with) contrast_Brain': 'Brain_MIR',
                    'Urine routine examination': 'U/A',
                    'Urine aerobic culture': 'U/C',
                    'Salmonella,Shigella or other Pathogens culture': 'Salmonella(_)',
                    'Stool Occult Blood(EIA/LIA) ç³ä¾¿æ½›è¡€å…ç–«åˆ†æ': 'Stool EIA(_/_)',
                    '(on Foley)ç•™ç½®å°å°¿ Urinal indwelling catheterlization(ç—…æˆ¿å°ˆç”¨)': 'On Foley',
                    '(ON NG TUBE)èƒƒç®¡æ’å…¥Insertion of nasogastric tube': 'On NG',
                    '(ICP)ä¸€èˆ¬å°å°¿ URINAL CATHETERLIZATION(ç—…æˆ¿å°ˆç”¨)': 'å–®æ¬¡å°å°¿',
                    '(ON CVP)ä¸­å¤®éœè„ˆå°ç®¡ç½®å…¥è¡“ C.V.P. CATHETER INTUBATION': 'On CVP',
                    'å°é‡æˆ–ç•™ç½®çŒè…¸': 'çŒè…¸',
                    'èƒ¸è…”ç©¿åˆº Thoracocentesis': 'èƒ¸è…”ç©¿åˆºå¼•æµ'
                };
                isMappingsLoaded = true;
                loadCustomMappingsFromStorage();
            }
        }

        // è®€å–ç³»çµ±è¨­ç½®ä¸­çš„è‡ªå®šç¾©è¡“èªå°ç…§è¡¨
        function loadCustomMappingsFromStorage() {
            try {
                const savedData = localStorage.getItem('medicalTermsMappings');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    customMappings = data.customMappings || {};
                    console.log(`ğŸ“‚ å·²è¼‰å…¥ ${Object.keys(customMappings).length} æ¢è‡ªå®šç¾©å°ç…§è¦å‰‡`);
                }
            } catch (error) {
                console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥è‡ªå®šç¾©å°ç…§è¡¨ï¼š', error);
                customMappings = {};
            }
        }

        function openTextConverter() {
            let processedMedicalData = null; // æš«å­˜è™•ç†å¾Œçš„é†«å›‘è³‡æ–™
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50; text-align: center;">æ€¥è¨ºé†«å›‘æª¢æŸ¥è™•ç½®</h3>
                <p style="margin-bottom: 15px; color: #6c757d;">è«‹è²¼ä¸Šæ€¥è¨ºä¸­çš„é†«å›‘æª¢æŸ¥è™•ç½®ï¼Œé—œé–‰è¦–çª—å¾Œå°‡è‡ªå‹•å¥—ç”¨ã€‚</p>
                <textarea id="medical_input" style="width: 100%; height: 300px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Microsoft JhengHei', sans-serif; font-size: 14px; line-height: 1.5;" placeholder="è«‹è²¼ä¸Šé†«ç™‚æª¢æŸ¥é …ç›®ï¼Œæ¯è¡Œä¸€å€‹é …ç›®..."></textarea>
                <div style="margin-top: 20px;">
                    <div id="convert_status_message" style="padding: 10px; border-radius: 6px; display: none;"></div>
                    <button id="close_btn" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer; min-width: 80px; float: right; margin-top: 10px;">é—œé–‰</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const textArea = document.getElementById('medical_input');
            const statusDiv = document.getElementById('convert_status_message');
            textArea.focus();
            
            // é—œé–‰è¦–çª—ä¸¦å¥—ç”¨è³‡æ–™çš„å‡½æ•¸
            function closeModalAndApplyData() {
                // å°‡æš«å­˜çš„è³‡æ–™å¥—ç”¨åˆ°æ–‡å­—æ¬„ä½
                if (processedMedicalData) {
                    document.getElementById('converted_text').value = processedMedicalData;
                    console.log('âœ… é†«å›‘è³‡æ–™å·²å¥—ç”¨åˆ°æ–‡å­—æ¬„ä½');
                }
                
                // é—œé–‰è¦–çª—
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }
            
            // è‡ªå‹•è½‰æ›åŠŸèƒ½ - è²¼ä¸Šå¾Œè§£æä½†ä¸ç«‹å³è¼¸å‡º
            textArea.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const inputData = textArea.value.trim();
                    if (inputData) {
                        try {
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#fff3cd';
                            statusDiv.style.color = '#856404';
                            statusDiv.style.border = '1px solid #ffeaa7';
                            statusDiv.textContent = 'âš¡ æ­£åœ¨è§£æé†«å›‘è³‡æ–™...';
                            
                            // è§£æè³‡æ–™ä½†ä¸ç›´æ¥è¼¸å‡ºåˆ°ä¸»æ–‡å­—æ¬„ä½
                            processedMedicalData = convertMedicalTerms(inputData);
                            
                            statusDiv.style.background = '#d4edda';
                            statusDiv.style.color = '#155724';
                            statusDiv.style.border = '1px solid #c3e6cb';
                            statusDiv.textContent = 'âœ… å®Œæˆï¼å°‡æœƒè‡ªå‹•é—œé–‰è¦–çª—ã€‚';
                            
                            console.log('âœ… é†«å›‘è§£æå®Œæˆï¼');
                            
                            // 2ç§’å¾Œè‡ªå‹•é—œé–‰ä¸¦å¥—ç”¨è³‡æ–™
                            setTimeout(() => {
                                if (document.body.contains(modal)) {
                                    console.log('ğŸšª è‡ªå‹•é—œé–‰è¦–çª—ä¸¦å¥—ç”¨é†«å›‘è³‡æ–™');
                                    closeModalAndApplyData();
                                }
                            }, 2000);
                            
                        } catch (error) {
                            console.error('âŒ é†«å›‘è§£æå¤±æ•—ï¼š', error);
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#f8d7da';
                            statusDiv.style.color = '#721c24';
                            statusDiv.style.border = '1px solid #f5c6cb';
                            statusDiv.textContent = 'âŒ è§£æå¤±æ•—ï¼š' + error.message;
                        }
                    } else {
                        statusDiv.style.display = 'none';
                        console.log('âš ï¸ è²¼ä¸Šçš„è³‡æ–™ç‚ºç©º');
                    }
                }, 100); // 100æ¯«ç§’å»¶é²ç¢ºä¿è²¼ä¸Šå…§å®¹å®Œå…¨è¼‰å…¥
            });
            
            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            document.getElementById('close_btn').onclick = () => {
                closeModalAndApplyData();
            };
            
            // é»æ“ŠèƒŒæ™¯é—œé–‰ä¸¦å¥—ç”¨è³‡æ–™
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModalAndApplyData();
                }
            };
            
            // ESCéµé—œé–‰ä¸¦å¥—ç”¨è³‡æ–™
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    if (document.body.contains(modal)) {
                        closeModalAndApplyData();
                    }
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }

        function convertMedicalTerms(inputText) {
            // è®€å–ç³»çµ±è¨­ç½®ä¸­çš„è‡ªå®šç¾©è¡“èªå°ç…§è¡¨
            const customMappings = loadCustomMappingsFromStorage();
            
            // åˆä½µé è¨­å’Œè‡ªå®šç¾©å°ç…§è¡¨
            const allMappings = { ...medicalTermsMapping, ...customMappings };
            
            const lines = inputText.split('\n');
            const convertedLines = [];
            let totalLines = 0;
            let convertedCount = 0;
            let defaultCount = 0;
            let hasBloodTest = false; // è¿½è¹¤æ˜¯å¦å·²æœ‰è¿½è¹¤æŠ½è¡€
            
            console.log(`ğŸ“Š ä½¿ç”¨å°ç…§è¡¨ï¼šé è¨­ ${Object.keys(medicalTermsMapping).length} æ¢ + è‡ªå®šç¾© ${Object.keys(customMappings).length} æ¢`);
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    totalLines++;
                    let converted = false;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªå®šç¾©çš„ = æ¨™è¨˜
                    if (trimmedLine.includes('=')) {
                        const parts = trimmedLine.split('=');
                        if (parts.length === 2) {
                            const result = parts[1].trim();
                            convertedLines.push(result);
                            convertedCount++;
                            converted = true;
                            console.log(`ğŸ”§ è‡ªå®šç¾©æ¨™è¨˜ï¼š${parts[0].trim()} â†’ ${result}`);
                        }
                    }
                    
                    if (!converted) {
                        // ç²¾ç¢ºåŒ¹é…åˆä½µå¾Œçš„å°ç…§è¡¨
                        if (allMappings[trimmedLine]) {
                            convertedLines.push(allMappings[trimmedLine]);
                            convertedCount++;
                            converted = true;
                            const isCustom = customMappings[trimmedLine] ? 'ï¼ˆè‡ªå®šç¾©ï¼‰' : '';
                            console.log(`âœ… ç²¾ç¢ºåŒ¹é…${isCustom}ï¼š${trimmedLine} â†’ ${allMappings[trimmedLine]}`);
                        } else {
                            // æ¨¡ç³ŠåŒ¹é…åˆä½µå¾Œçš„å°ç…§è¡¨
                            for (const [key, value] of Object.entries(allMappings)) {
                                if (key.includes(trimmedLine) || trimmedLine.includes(key)) {
                                    convertedLines.push(value);
                                    convertedCount++;
                                    converted = true;
                                    const isCustom = customMappings[key] ? 'ï¼ˆè‡ªå®šç¾©ï¼‰' : '';
                                    console.log(`ğŸ” æ¨¡ç³ŠåŒ¹é…${isCustom}ï¼š${trimmedLine} â†’ ${value}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœéƒ½æ²’æœ‰åŒ¹é…åˆ°ï¼Œé è¨­ç‚º"è¿½è¹¤æŠ½è¡€"ï¼ˆä½†åªåŠ å…¥ä¸€æ¬¡ï¼‰
                    if (!converted) {
                        if (!hasBloodTest) {
                            convertedLines.push('äºˆè¿½è¹¤æŠ½è¡€');
                            hasBloodTest = true;
                            console.log(`ğŸ“‹ é è¨­è™•ç†ï¼ˆé¦–æ¬¡ï¼‰ï¼š${trimmedLine} â†’ äºˆè¿½è¹¤æŠ½è¡€`);
                        } else {
                            console.log(`ğŸ“‹ é è¨­è™•ç†ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š${trimmedLine} â†’ äºˆè¿½è¹¤æŠ½è¡€ï¼ˆä¸é‡è¤‡åŠ å…¥ï¼‰`);
                        }
                        defaultCount++;
                    }
                }
            });
            
            // åˆä½µç›¸åŒçš„è¡€æ¶²åŸ¹é¤Šé …ç›®ä¸¦è¨ˆç®—å¥—æ•¸
            const mergedResults = mergeBloodCultures(convertedLines);
            
            return mergedResults.join('ã€');
        }

        function mergeBloodCultures(convertedLines) {
            const itemCount = {};
            const mergedResults = [];
            
            // è¨ˆç®—æ¯å€‹é …ç›®çš„å‡ºç¾æ¬¡æ•¸
            convertedLines.forEach(item => {
                if (item === 'B/C*1å¥—') {
                    itemCount['B/C'] = (itemCount['B/C'] || 0) + 1;
                } else if (item === 'ARD*1å¥—') {
                    itemCount['ARD'] = (itemCount['ARD'] || 0) + 1;
                } else {
                    // éè¡€æ¶²åŸ¹é¤Šé …ç›®ï¼Œç›´æ¥åŠ å…¥çµæœ
                    mergedResults.push(item);
                }
            });
            
            // å°‡è¡€æ¶²åŸ¹é¤Šé …ç›®åŠ å…¥çµæœï¼Œä¸¦æ¨™ç¤ºæ­£ç¢ºçš„å¥—æ•¸
            for (const [key, count] of Object.entries(itemCount)) {
                mergedResults.push(`${key}*${count}å¥—`);
            }
            
            return mergedResults;
        }

        function copyConvertedText() {
            const convertedText = document.getElementById('converted_text').value;
            if (!convertedText.trim()) {
                console.log('âš ï¸ æ²’æœ‰å¯è¤‡è£½çš„è½‰æ›çµæœ');
                return;
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(convertedText).then(() => {
                    console.log('âœ… è½‰æ›çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                    
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… å·²è¤‡è£½';
                    btn.style.background = '#28a745';
                    
                    const successMsg = document.getElementById('convert_success_message');
                    successMsg.style.display = 'block';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        successMsg.style.display = 'none';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—ï¼š', err);
                    fallbackCopyConverted(convertedText);
                });
            } else {
                fallbackCopyConverted(convertedText);
            }
        }

        function fallbackCopyConverted(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('âœ… è½‰æ›çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼ˆå‚™ç”¨æ–¹æ³•ï¼‰');
                
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                
            } catch (err) {
                console.log('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½');
            }
            document.body.removeChild(textArea);
        }

        function clearConvertedText() {
            document.getElementById('converted_text').value = '';
            console.log('âœ… è½‰æ›çµæœå·²æ¸…é™¤');
        }

        function generateEmergencyRecord() {
            const data = {
                patient: {
                    admission_date: document.getElementById('admission_date').value,
                    admission_method: document.getElementById('admission_method').value,
                    admission_reason: document.getElementById('admission_reason').value,
                    chief_complaint: document.getElementById('chief_complaint').value
                },
                vitals: {
                    temperature: document.getElementById('temperature').value,
                    pulse: document.getElementById('pulse').value,
                    respiration: document.getElementById('respiration').value,
                    blood_pressure: document.getElementById('blood_pressure').value,
                    spo2: document.getElementById('spo2').value,
                    blood_sugar: document.getElementById('blood_sugar').value,
                    oxygen_device: document.getElementById('oxygen_device').value
                },
                consciousness: {
                    e: document.getElementById('consciousness_e').value,
                    v: document.getElementById('consciousness_v').value,
                    m: document.getElementById('consciousness_m').value
                },
                diagnosis: document.getElementById('diagnosis').value,
                past_history: document.getElementById('past_history').value,
                present_history: document.getElementById('present_history').value
            };

            const recordParts = [];

            // å…¥é™¢æ—¥æœŸ
            if (data.patient.admission_date) {
                recordParts.push(data.patient.admission_date);
            }

            // å…¥é™¢æ–¹å¼
            if (data.patient.admission_method) {
                recordParts.push(data.patient.admission_method);
            }

            // ç—…äººæ„è­˜
            if (data.consciousness.e || data.consciousness.v || data.consciousness.m) {
                recordParts.push(`E${data.consciousness.e}V${data.consciousness.v}M${data.consciousness.m}`);
            }

            // å…¥é™¢åŸå› 
            if (data.patient.admission_reason) {
                recordParts.push(data.patient.admission_reason);
            }

            // ä¸»è¨´æˆ–ä»£è¨´
            if (data.patient.chief_complaint) {
                recordParts.push(data.patient.chief_complaint);
            }

            // ç”Ÿå‘½å¾µè±¡
            const vitals = [];
            if (data.vitals.temperature) vitals.push(`é«”æº«${data.vitals.temperature}Â°C`);
            if (data.vitals.pulse) vitals.push(`è„ˆæ${data.vitals.pulse}æ¬¡/åˆ†`);
            if (data.vitals.respiration) vitals.push(`å‘¼å¸${data.vitals.respiration}æ¬¡/åˆ†`);
            if (data.vitals.blood_pressure) vitals.push(`è¡€å£“${data.vitals.blood_pressure}mmHg`);
            if (data.vitals.spo2) vitals.push(`è¡€æ°§${data.vitals.spo2}%`);
            if (data.vitals.blood_sugar) vitals.push(`è¡€ç³–${data.vitals.blood_sugar}mg/dL`);
            
            if (vitals.length > 0) {
                recordParts.push(vitals.join('ã€'));
            }

            // æ°§æ°£è£ç½®
            if (data.vitals.oxygen_device) {
                if (data.vitals.oxygen_device === 'æ¡å®¤æ°§æ¿ƒåº¦') {
                    recordParts.push(data.vitals.oxygen_device);
                } else {
                    recordParts.push(`${data.vitals.oxygen_device}æ°§æ°£ä½¿ç”¨`);
                }
            }

            // ç™¼ç”Ÿäº‹ä»¶ï¼ˆåŸç¾åœ¨ç—…å²ï¼‰
            if (data.present_history) {
                recordParts.push(data.present_history);
            }

            // åˆæ­¥è¨ºæ–·
            if (data.diagnosis) {
                recordParts.push(data.diagnosis);
            }

            // éå»ç—…å²
            if (data.past_history) {
                recordParts.push(data.past_history);
            }

            // è½‰æ›å¾Œçš„é†«å›‘è³‡æ–™
            const convertedData = document.getElementById('converted_text').value;
            if (convertedData && convertedData.trim() !== '') {
                recordParts.push(convertedData);
            }

            // å›ºå®šçµå°¾
            if (recordParts.length > 0) {
                recordParts.push('ç¶“é†«å¸«è©•ä¼°å¾Œå»ºè­°å…¥é™¢æ²»ç™‚');
            }

            // çµ„åˆå®Œæ•´ç´€éŒ„
            let finalRecord = '';
            if (recordParts.length > 0) {
                finalRecord = recordParts.join('ï¼Œ') + 'ã€‚';
            }

            document.getElementById('emergency_record').value = finalRecord;

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const successMsg = document.getElementById('success_message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        function clearAllFields() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.value = '';
            });
            console.log('âœ… æ‰€æœ‰æ¬„ä½å·²æ¸…é™¤');
        }



        function copyRecord() {
            const recordText = document.getElementById('emergency_record').value;
            if (!recordText.trim()) {
                console.log('âš ï¸ æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(recordText).then(() => {
                    console.log('âœ… æ€¥è¨ºå…¥é™¢ç´€éŒ„å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                    
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… å·²è¤‡è£½';
                    btn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1500);
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—ï¼š', err);
                });
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è¡“èªå°ç…§è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            loadMedicalTermsMapping();
        });
    </script>
</body>
</html> 